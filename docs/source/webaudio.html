<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * webaudio.js
 */

tm.sound = tm.sound || {};

(function() {

<span id='tm-sound-WebAudio'>    /**
</span>     * @class
     * WebAudioクラス
     */
    tm.sound.WebAudio = tm.createClass({
        loaded: false,
        context: null,
        buffer: null,
        panner: null,

        /**
<span id='tm-sound-WebAudio-property-volume'>         * ボリューム
</span>         */
        volume: 1.0,

        _playingSources: [],

        /**
<span id='tm-sound-WebAudio-method-init'>         *　初期化
</span>         */
        init: function(src_or_buffer) {
            this.context = tm.sound.WebAudioManager.context;

            if (typeof(src_or_buffer)===&quot;string&quot;) {
                this._load(src_or_buffer);
            }
            else {
                this.buffer = src_or_buffer;
                this.loaded = true;
                this._setup();
            }
        },

        /**
         * 再生
<span id='tm-sound-WebAudio-method-play'>         */
</span>        play: function() {
            if (this.source.start) {
                this.source.start(0);
            } else {
                this.source.noteOn(0);
            }
        },

        /**
         * 停止
<span id='tm-sound-WebAudio-method-stop'>         */
</span>        stop: function() {
            if (this.source.stop) {
                this.source.stop(0);
            } else {
                this.source.noteOff(0);
            }
        },

        /**
         * 複製
         */
<span id='tm-sound-WebAudio-method-clone'>        clone: function() {
</span>            var webAudio = tm.sound.WebAudio(this.buffer);
            webAudio.volume = this.volume;
            return webAudio;
        },
        /**
         * dummy
         */
<span id='tm-sound-WebAudio-method-setPosition'>        setPosition: function(x, y, z) {
</span>            this.panner.setPosition(x, y||0, z||0);
        },
        /**
         * dummy
         */
<span id='tm-sound-WebAudio-method-setVelocity'>        setVelocity: function(x, y, z) {
</span>            this.panner.setVelocity(x, y||0, z||0);
        },
        /**
         * dummy
         */
<span id='tm-sound-WebAudio-method-setOrientation'>        setOrientation: function(x, y, z) {
</span>            this.panner.setOrientation(x, y||0, z||0);
        },

        _load: function(src) {
            var xhr = new XMLHttpRequest();
            var self = this;
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200 || xhr.status === 0) {
                        self.context.decodeAudioData(xhr.response, function(buffer) {
                            self.buffer = buffer;
                            self.loaded = true;
                            self._setup();
                        });
                    } else {
                        onsole.error(xhr);
                    }
                }
            };
            xhr.open(&quot;GET&quot;, src, true);
            xhr.responseType = &quot;arraybuffer&quot;;
            xhr.send();
        },

        _setup: function() {
            this.source = this.context.createBufferSource();
            this.panner     = this.context.createPanner();
            this.analyser   = this.context.createAnalyser();

            this.source.buffer = this.buffer;
            
            this.source.connect(this.panner);
            this.panner.connect(this.context.destination);

            this.source.gain.value = this.volume;

            this.source.connect(this.analyser);
            this.analyser.connect(this.context.destination);
        }
    });
    
})();



(function() {

    /**
<span id='WebAudio'>     * @class   WebAudioマネージャクラス
</span>     * WebAudioを管理するクラス
     */
    tm.sound.WebAudioManager = {
        context: tm.global.webkitAudioContext ? new webkitAudioContext() : null,
        sounds: {}
    };

    /**
     * @static
     * @method
     * 追加
     */
<span id='WebAudio-static-method-add'>    tm.sound.WebAudioManager.add = function(name, src) {
</span>        this.sounds[name] = tm.sound.WebAudio(src);
        return this;
    };

    /**
     * @static
     * @method
     * 取得
     */
<span id='WebAudio-static-method-get'>    tm.sound.WebAudioManager.get = function(name) {
</span>        return this.sounds[name].clone();
    };

    /**
     * @static
     * @method
     * ロードチェック
     */
<span id='WebAudio-static-method-isLoaded'>    tm.sound.WebAudioManager.isLoaded = function() {
</span>        for (var key in this.sounds) {
            if (this.sounds[key].loaded === false) {
                return false;
            }
        }
        return true;
    };

    tm.addLoadCheckList(tm.sound.WebAudioManager);

})();

</pre>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * assetmanger.js
 */

(function() {

    tm.asset = tm.asset || {};

<span id='tm-asset-AssetManager'>    /**
</span>     * @class tm.asset.AssetManager
     * マップシート
     * @extends tm.event.EventDispatcher
     */
    tm.define(&quot;tm.asset.AssetManager&quot;, {
        superClass: &quot;tm.event.EventDispatcher&quot;,

<span id='tm-asset-AssetManager-method-constructor'>        /**
</span>         * @constructor
         * コンストラクタ
         */
        init: function() {
            this.superInit();

            this.assets = {};

            this._funcs = [];
            this._loadedCounter = 0;
        },

<span id='tm-asset-AssetManager-property-load'>        /**
</span>         * @property
         * アセットのロード
         * @param {Object} key
         * @param {Object} path
         */
        load: function(key, path, type) {
            if (typeof arguments[0] == 'string') {
                path = (arguments.length &lt; 2) ? key : path;
                this._load(key, path, type);
            }
            else {
                var hash = arguments[0];
                for (var key in hash) {
                    var value = hash[key];
                    if (typeof value == 'string') {
                        this._load(key, value);
                    }
                    else {
                        this._load(key, value['url'], value['type']);
                    }
                }
            }

            // 重複ロード対応
            if (this.isLoaded()) {
                var e = tm.event.Event(&quot;load&quot;);
                this.dispatchEvent(e);
            }

            return this;
        },

<span id='tm-asset-AssetManager-property-_load'>        /**
</span>         * @property
         * アセットのロード
         * private
         * @param {Object} key
         * @param {Object} path
         * @param {Object} type
         */
        _load: function(key, path, type) {
            if (this.contains(key)) return ;

            // type が省略されている場合は拡張子から判定する
            type = type || path.split('.').last;

            var asset = this._funcs[type](path);
            this.assets[key] = asset;

            if (asset.loaded == false) {
                asset.addEventListener(&quot;load&quot;, this._checkLoadedFunc.bind(this));
            }
            else {
                this._checkLoadedFunc();
            }

            return this;
        },

<span id='tm-asset-AssetManager-property-get'>        /**
</span>         * @property
         * アセットのゲット
         * @param {Object} key
         */
        get: function(key) {
            return this.assets[key];
        },

<span id='tm-asset-AssetManager-property-set'>        /**
</span>         * @property
         * アセットのセット
         * @param {Object} key
         * @param {Object} asset
         */
        set: function(key, asset) {
            this.assets[key] = asset;
            return this;
        },

<span id='tm-asset-AssetManager-property-contains'>        /**
</span>         * @property
         * @TODO ?
         * @param {Object} key
         */
        contains: function(key) {
            return (this.assets[key]) ? true : false;
        },

<span id='tm-asset-AssetManager-property-register'>        /**
</span>         * @property
         * アセットのセット
         * @param {Object} key
         * @param {Object} asset
         */
        register: function(type, fn) {
            this._funcs[type] = fn;
        },

<span id='tm-asset-AssetManager-property-isLoaded'>        /**
</span>         * @property
         * ロード済みか調べる
         */
        isLoaded: function() {
            return (this._loadedCounter == Object.keys(this.assets).length);
        },

<span id='tm-asset-AssetManager-property-_checkLoadedFunc'>        /**
</span>         * @property
         * @TODO ?
         * @private
         */
        _checkLoadedFunc: function() {
            this._loadedCounter++;

            if (this.isLoaded()) {
                var e = tm.event.Event(&quot;load&quot;);
                this.dispatchEvent(e);
            }
        }

    });

    tm.asset.AssetManager = tm.asset.AssetManager();

    var _textureFunc = function(path) {
        var texture = tm.asset.Texture(path);
        return texture;
    };
    var _soundFunc = function(path) {
        var audio = tm.sound.WebAudio(path);
        return audio;
    };
    
    var _tmxFunc = function(path) {
        var mapSheet = tm.asset.MapSheet(path);
        return mapSheet;
    };
    
    var _tmssFunc = function(path) {
        var ss = tm.asset.SpriteSheet(path);
        return ss;
    };

    var _jsonFunc = function(path) {
        var file = tm.util.File();
        if (typeof path == 'string') {
            file.load({
                url: path,
                dataType: 'json',
                success: function(o) {
                    self.$extend(o);
                    self.loaded = true;
                }
            });
        }
        else {
            var data = path;
            file.setData(path);
        }

        return file;
    };

    // image
    tm.asset.AssetManager.register(&quot;png&quot;, _textureFunc);
    tm.asset.AssetManager.register(&quot;gif&quot;, _textureFunc);
    tm.asset.AssetManager.register(&quot;jpg&quot;, _textureFunc);
    tm.asset.AssetManager.register(&quot;jpeg&quot;, _textureFunc);

    // sound
    tm.asset.AssetManager.register(&quot;wav&quot;, _soundFunc);
    tm.asset.AssetManager.register(&quot;mp3&quot;, _soundFunc);
    tm.asset.AssetManager.register(&quot;ogg&quot;, _soundFunc);

    // json
    tm.asset.AssetManager.register(&quot;json&quot;, _jsonFunc);

    // map data
    tm.asset.AssetManager.register(&quot;tmx&quot;, _tmxFunc);
    
    // spritesheet for tmlib.js
    tm.asset.AssetManager.register(&quot;tmss&quot;, _tmssFunc);

})();










</pre>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * keyboard.js
 */

tm.input = tm.input || {};


(function() {
    
<span id='tm-input-Keyboard'>    /**
</span>     * @class tm.input.Keyboard
     * キーボードクラス
     */
    tm.input.Keyboard = tm.createClass({
        
<span id='tm-input-Keyboard-property-element'>        /**
</span>         * target element
         */
        element: null,
        
        key: null,
        
        press   : null, // 押しているキー
        down    : null, // 押したキー
        up      : null, // 離したキー
        last    : null, // 押していたキー
        
<span id='tm-input-Keyboard-method-constructor'>        /**
</span>         * @constructor
         * &lt;a href=&quot;http://tmlib-js.googlecode.com/svn/trunk/test/input/keyboard-test.html&quot;&gt;Test Program&lt;/a&gt;.
         * ### Example
         * TM.loadScript(&quot;input&quot;, &quot;keyboard&quot;);
         *  
         * TM.main(function() {
         *     var k = TM.$Key(document);
         *     k.run();
         *     TM.setLoop(function(){
         *         if (k.getKey('a')) { console.log(&quot;press 'a'!!&quot;); }
         *     });
         * });
         */
        init: function(element) {
            this.element = element || document;
            
            this.key = {};
            
            this.press  = {};
            this.down   = {};
            this.up     = {};
            this.last   = {};
            
            var self = this;
            this.element.addEventListener(&quot;keydown&quot;, function(e){
                self.key[e.keyCode] = true;
            });
            this.element.addEventListener(&quot;keyup&quot;, function(e){
                // delete self.key[e.keyCode];
                self.key[e.keyCode] = false;
                // self.button |= 1&lt;&lt;e.button;
            });
            this.element.addEventListener(&quot;keypress&quot;, function(e){
                // self.button &amp;= ~(1&lt;&lt;e.button);
            });
        },
        
<span id='tm-input-Keyboard-property-run'>        /**
</span>         * @property
         * run.
         * 自動でマウス情報を更新したい際に使用する
         */
        run: function(fps) {
            var self = this;
            fps = fps || 30;
            tm.setLoop(function(){
                self._update();
                if (self.update) self.update();
            }, 1000/fps);
        },
        
<span id='tm-input-Keyboard-property-_update'>        /**
</span>         * @property
         * 情報更新処理
         * マイフレーム呼んで下さい.
         * @private
         */
        _update: function() {
            // TODO: 一括ビット演算で行うよう修正する
            for (var k in this.key) {
                this.last[k]    = this.press[k];
                this.press[k]   = this.key[k];
                
                this.down[k] = (this.press[k] ^ this.last[k]) &amp; this.press[k];
                this.up[k] = (this.press[k] ^ this.last[k]) &amp; this.last[k];
            }
            
            return this;
        },
        
<span id='tm-input-Keyboard-property-getKey'>        /**
</span>         * @property
         * キーを押しているかをチェック
         * @param   {Number/String} key keyCode or keyName
         * @returns {Boolean}   チェック結果
         */
        getKey: function(key) {
            if (typeof(key) == &quot;string&quot;) {
                key = KEY_CODE[key];
            }
            return this.press[key] == true;
        },
        
<span id='tm-input-Keyboard-property-getKeyDown'>        /**
</span>         * @property
         * キーを押したかをチェック
         * @param   {Number/String} key keyCode or keyName
         * @returns {Boolean}   チェック結果
         */
        getKeyDown: function(key) {
            if (typeof(key) == &quot;string&quot;) {
                key = KEY_CODE[key];
            }
            return this.down[key] == true;
        },
        
<span id='tm-input-Keyboard-property-getKeyUp'>        /**
</span>         * @property
         * キーを離したかをチェック
         * @param   {Number/String} key keyCode or keyName
         * @returns {Boolean}   チェック結果
         */
        getKeyUp: function(key) {
            if (typeof(key) == &quot;string&quot;) {
                key = KEY_CODE[key];
            }
            return this.up[key] == true;
        },
        
<span id='tm-input-Keyboard-property-getKeyAngle'>        /**
</span>         * @property
         * キーの方向を Angle(Degree) で取得
         * @returns {Boolean}   角度(Degree)
         */
        getKeyAngle: function() {
            var angle = null;
            var arrowBit =
                (this.getKey(&quot;left&quot;)   &lt;&lt; 3) | // 1000
                (this.getKey(&quot;up&quot;)     &lt;&lt; 2) | // 0100
                (this.getKey(&quot;right&quot;)  &lt;&lt; 1) | // 0010
                (this.getKey(&quot;down&quot;));         // 0001
            
            if (arrowBit != 0 &amp;&amp; ARROW_BIT_TO_ANGLE_TABLE.hasOwnProperty(arrowBit)) {
                angle = ARROW_BIT_TO_ANGLE_TABLE[arrowBit];
            }
            
            return angle;
        },
        
<span id='tm-input-Keyboard-method-setKey'>        /**
</span>         * キーの状態を設定する
         */
        setKey: function(key, flag) {
            if (typeof(key) == &quot;string&quot;) {
                key = KEY_CODE[key];
            }
            return this.press[key] = flag;
        },

<span id='tm-input-Keyboard-method-clearKey'>        /**
</span>         * キーを全て離したことにする
         */
        clearKey: function() {
            this.press = {};
        }
        
    });

    /*
     * @enum ARROW_BIT_TO_ANGLE_TABLE
     * 方向のアングル jsduckでは数字をプロパティに指定できない？
     * @private
     */
    var ARROW_BIT_TO_ANGLE_TABLE = {
        /* @property 下 */
        0x01: 270,
        /* @property 右 */
        0x02:   0,
        /* @property 上 */
        0x04:  90,
        /* @property 左 */
        0x08: 180,

        /* @property 右上 */
        0x06:  45,
        /* @property 右下 */
        0x03: 315,
        /* @property 左上 */
        0x0c: 135,
        /* @property 左下 */
        0x09: 225,

        // 三方向同時押し対応
        // 想定外の操作だが対応しといたほうが無難
        /* @property 右上左 */
        0x0e:  90,
        /* @property 上左下 */
        0x0d: 180,
        /* @property 左下右 */
        0x0b: 270,
        /* @property 下右上 */
        0x07:   0,
    };

<span id='KEY_CODE'>    /**
</span>     * @enum KEY_CODE
     * キー番号
     * @private
     */
    var KEY_CODE = {
<span id='KEY_CODE-property-backspace'>        /** @property */
</span>        &quot;backspace&quot; : 8,
<span id='KEY_CODE-property-tab'>        /** @property */
</span>        &quot;tab&quot;       : 9,
<span id='KEY_CODE-property-enter'>        /** @property */
</span>        &quot;enter&quot;     : 13,
<span id='KEY_CODE-property-return'>        /** @property */
</span>        &quot;return&quot;    : 13,
<span id='KEY_CODE-property-shift'>        /** @property */
</span>        &quot;shift&quot;     : 16,
<span id='KEY_CODE-property-ctrl'>        /** @property */
</span>        &quot;ctrl&quot;      : 17,
<span id='KEY_CODE-property-alt'>        /** @property */
</span>        &quot;alt&quot;       : 18,
<span id='KEY_CODE-property-pause'>        /** @property */
</span>        &quot;pause&quot;     : 19,
<span id='KEY_CODE-property-capslock'>        /** @property */
</span>        &quot;capslock&quot;  : 20,
<span id='KEY_CODE-property-escape'>        /** @property */
</span>        &quot;escape&quot;    : 27,
<span id='KEY_CODE-property-pageup'>        /** @property */
</span>        &quot;pageup&quot;    : 33,
<span id='KEY_CODE-property-pagedown'>        /** @property */
</span>        &quot;pagedown&quot;  : 34,
<span id='KEY_CODE-property-end'>        /** @property */
</span>        &quot;end&quot;       : 35,
<span id='KEY_CODE-property-home'>        /** @property */
</span>        &quot;home&quot;      : 36,
<span id='KEY_CODE-property-left'>        /** @property */
</span>        &quot;left&quot;      : 37,
<span id='KEY_CODE-property-up'>        /** @property */
</span>        &quot;up&quot;        : 38,
<span id='KEY_CODE-property-right'>        /** @property */
</span>        &quot;right&quot;     : 39,
<span id='KEY_CODE-property-down'>        /** @property */
</span>        &quot;down&quot;      : 40,
<span id='KEY_CODE-property-insert'>        /** @property */
</span>        &quot;insert&quot;    : 45,
<span id='KEY_CODE-property-delete'>        /** @property */
</span>        &quot;delete&quot;    : 46,
        
<span id='KEY_CODE-property-0'>        /** @property */
</span>        &quot;0&quot; : 48,
<span id='KEY_CODE-property-1'>        /** @property */
</span>        &quot;1&quot; : 49,
<span id='KEY_CODE-property-2'>        /** @property */
</span>        &quot;2&quot; : 50,
<span id='KEY_CODE-property-3'>        /** @property */
</span>        &quot;3&quot; : 51,
<span id='KEY_CODE-property-4'>        /** @property */
</span>        &quot;4&quot; : 52,
<span id='KEY_CODE-property-5'>        /** @property */
</span>        &quot;5&quot; : 53,
<span id='KEY_CODE-property-6'>        /** @property */
</span>        &quot;6&quot; : 54,
<span id='KEY_CODE-property-7'>        /** @property */
</span>        &quot;7&quot; : 55,
<span id='KEY_CODE-property-8'>        /** @property */
</span>        &quot;8&quot; : 56,
<span id='KEY_CODE-property-9'>        /** @property */
</span>        &quot;9&quot; : 57,
<span id='KEY_CODE-property-a'>        /** @property */
</span>        
        &quot;a&quot; : 65,
<span id='KEY_CODE-property-A'>        /** @property */
</span>        &quot;A&quot; : 65,
<span id='KEY_CODE-property-b'>        /** @property */
</span>        &quot;b&quot; : 66,
<span id='KEY_CODE-property-B'>        /** @property */
</span>        &quot;B&quot; : 66,
<span id='KEY_CODE-property-c'>        /** @property */
</span>        &quot;c&quot; : 67,
<span id='KEY_CODE-property-C'>        /** @property */
</span>        &quot;C&quot; : 67,
<span id='KEY_CODE-property-d'>        /** @property */
</span>        &quot;d&quot; : 68,
<span id='KEY_CODE-property-D'>        /** @property */
</span>        &quot;D&quot; : 68,
<span id='KEY_CODE-property-e'>        /** @property */
</span>        &quot;e&quot; : 69,
<span id='KEY_CODE-property-E'>        /** @property */
</span>        &quot;E&quot; : 69,
<span id='KEY_CODE-property-f'>        /** @property */
</span>        &quot;f&quot; : 70,
<span id='KEY_CODE-property-F'>        /** @property */
</span>        &quot;F&quot; : 70,
<span id='KEY_CODE-property-g'>        /** @property */
</span>        &quot;g&quot; : 71,
<span id='KEY_CODE-property-G'>        /** @property */
</span>        &quot;G&quot; : 71,
<span id='KEY_CODE-property-h'>        /** @property */
</span>        &quot;h&quot; : 72,
<span id='KEY_CODE-property-H'>        /** @property */
</span>        &quot;H&quot; : 72,
<span id='KEY_CODE-property-i'>        /** @property */
</span>        &quot;i&quot; : 73,
<span id='KEY_CODE-property-I'>        /** @property */
</span>        &quot;I&quot; : 73,
<span id='KEY_CODE-property-j'>        /** @property */
</span>        &quot;j&quot; : 74,
<span id='KEY_CODE-property-J'>        /** @property */
</span>        &quot;J&quot; : 74,
<span id='KEY_CODE-property-k'>        /** @property */
</span>        &quot;k&quot; : 75,
<span id='KEY_CODE-property-K'>        /** @property */
</span>        &quot;K&quot; : 75,
<span id='KEY_CODE-property-l'>        /** @property */
</span>        &quot;l&quot; : 76,
<span id='KEY_CODE-property-L'>        /** @property */
</span>        &quot;L&quot; : 76,
<span id='KEY_CODE-property-m'>        /** @property */
</span>        &quot;m&quot; : 77,
<span id='KEY_CODE-property-M'>        /** @property */
</span>        &quot;M&quot; : 77,
<span id='KEY_CODE-property-n'>        /** @property */
</span>        &quot;n&quot; : 78,
<span id='KEY_CODE-property-N'>        /** @property */
</span>        &quot;N&quot; : 78,
<span id='KEY_CODE-property-o'>        /** @property */
</span>        &quot;o&quot; : 79,
<span id='KEY_CODE-property-O'>        /** @property */
</span>        &quot;O&quot; : 79,
<span id='KEY_CODE-property-p'>        /** @property */
</span>        &quot;p&quot; : 80,
<span id='KEY_CODE-property-P'>        /** @property */
</span>        &quot;P&quot; : 80,
<span id='KEY_CODE-property-q'>        /** @property */
</span>        &quot;q&quot; : 81,
<span id='KEY_CODE-property-Q'>        /** @property */
</span>        &quot;Q&quot; : 81,
<span id='KEY_CODE-property-r'>        /** @property */
</span>        &quot;r&quot; : 82,
<span id='KEY_CODE-property-R'>        /** @property */
</span>        &quot;R&quot; : 82,
<span id='KEY_CODE-property-s'>        /** @property */
</span>        &quot;s&quot; : 83,
<span id='KEY_CODE-property-S'>        /** @property */
</span>        &quot;S&quot; : 83,
<span id='KEY_CODE-property-t'>        /** @property */
</span>        &quot;t&quot; : 84,
<span id='KEY_CODE-property-T'>        /** @property */
</span>        &quot;T&quot; : 84,
<span id='KEY_CODE-property-u'>        /** @property */
</span>        &quot;u&quot; : 85,
<span id='KEY_CODE-property-U'>        /** @property */
</span>        &quot;U&quot; : 85,
<span id='KEY_CODE-property-v'>        /** @property */
</span>        &quot;v&quot; : 86,
<span id='KEY_CODE-property-V'>        /** @property */
</span>        &quot;V&quot; : 86,
<span id='KEY_CODE-property-w'>        /** @property */
</span>        &quot;w&quot; : 87,
<span id='KEY_CODE-property-W'>        /** @property */
</span>        &quot;W&quot; : 87,
<span id='KEY_CODE-property-x'>        /** @property */
</span>        &quot;x&quot; : 88,
<span id='KEY_CODE-property-X'>        /** @property */
</span>        &quot;X&quot; : 88,
<span id='KEY_CODE-property-y'>        /** @property */
</span>        &quot;y&quot; : 89,
<span id='KEY_CODE-property-Y'>        /** @property */
</span>        &quot;Y&quot; : 89,
<span id='KEY_CODE-property-z'>        /** @property */
</span>        &quot;z&quot; : 90,
<span id='KEY_CODE-property-Z'>        /** @property */
</span>        &quot;Z&quot; : 90,
        
<span id='KEY_CODE-property-numpad0'>        /** @property */
</span>        &quot;numpad0&quot; : 96,
<span id='KEY_CODE-property-numpad1'>        /** @property */
</span>        &quot;numpad1&quot; : 97,
<span id='KEY_CODE-property-numpad2'>        /** @property */
</span>        &quot;numpad2&quot; : 98,
<span id='KEY_CODE-property-numpad3'>        /** @property */
</span>        &quot;numpad3&quot; : 99,
<span id='KEY_CODE-property-numpad4'>        /** @property */
</span>        &quot;numpad4&quot; : 100,
<span id='KEY_CODE-property-numpad5'>        /** @property */
</span>        &quot;numpad5&quot; : 101,
<span id='KEY_CODE-property-numpad6'>        /** @property */
</span>        &quot;numpad6&quot; : 102,
<span id='KEY_CODE-property-numpad7'>        /** @property */
</span>        &quot;numpad7&quot; : 103,
<span id='KEY_CODE-property-numpad8'>        /** @property */
</span>        &quot;numpad8&quot; : 104,
<span id='KEY_CODE-property-numpad9'>        /** @property */
</span>        &quot;numpad9&quot; : 105,
<span id='KEY_CODE-property-multiply'>        /** @property */
</span>        &quot;multiply&quot;      : 106,
<span id='KEY_CODE-property-add'>        /** @property */
</span>        &quot;add&quot;           : 107,
<span id='KEY_CODE-property-subtract'>        /** @property */
</span>        &quot;subtract&quot;      : 109,
<span id='KEY_CODE-property-decimalpoint'>        /** @property */
</span>        &quot;decimalpoint&quot;  : 110,
<span id='KEY_CODE-property-divide'>        /** @property */
</span>        &quot;divide&quot;        : 111,

<span id='KEY_CODE-property-f1'>        /** @property */
</span>        &quot;f1&quot;    : 112,
<span id='KEY_CODE-property-f2'>        /** @property */
</span>        &quot;f2&quot;    : 113,
<span id='KEY_CODE-property-f3'>        /** @property */
</span>        &quot;f3&quot;    : 114,
<span id='KEY_CODE-property-f4'>        /** @property */
</span>        &quot;f4&quot;    : 115,
<span id='KEY_CODE-property-f5'>        /** @property */
</span>        &quot;f5&quot;    : 116,
<span id='KEY_CODE-property-f6'>        /** @property */
</span>        &quot;f6&quot;    : 117,
<span id='KEY_CODE-property-f7'>        /** @property */
</span>        &quot;f7&quot;    : 118,
<span id='KEY_CODE-property-f8'>        /** @property */
</span>        &quot;f8&quot;    : 119,
<span id='KEY_CODE-property-f9'>        /** @property */
</span>        &quot;f9&quot;    : 120,
<span id='KEY_CODE-property-f10'>        /** @property */
</span>        &quot;f10&quot;   : 121,
<span id='KEY_CODE-property-f11'>        /** @property */
</span>        &quot;f11&quot;   : 122,
<span id='KEY_CODE-property-f12'>        /** @property */
</span>        &quot;f12&quot;   : 123,
        
<span id='KEY_CODE-property-numlock'>        /** @property */
</span>        &quot;numlock&quot;   : 144,
<span id='KEY_CODE-property-scrolllock'>        /** @property */
</span>        &quot;scrolllock&quot;: 145,
<span id='KEY_CODE-property-semicolon'>        /** @property */
</span>        &quot;semicolon&quot; : 186,
<span id='KEY_CODE-property-equalsign'>        /** @property */
</span>        &quot;equalsign&quot; : 187,
<span id='KEY_CODE-property-comma'>        /** @property */
</span>        &quot;comma&quot;     : 188,
<span id='KEY_CODE-property-dash'>        /** @property */
</span>        &quot;dash&quot;      : 189,
<span id='KEY_CODE-property-period'>        /** @property */
</span>        &quot;period&quot;    : 190,
<span id='KEY_CODE-property-forward slash'>        /** @property */
</span>        &quot;forward slash&quot; : 191,
<span id='KEY_CODE-property-/'>        /** @property */
</span>        &quot;/&quot;: 191,
<span id='KEY_CODE-property-grave accent'>        /** @property */
</span>        &quot;grave accent&quot;  : 192,
<span id='KEY_CODE-property-open bracket'>        /** @property */
</span>        &quot;open bracket&quot;  : 219,
<span id='KEY_CODE-property-back slash'>        /** @property */
</span>        &quot;back slash&quot;    : 220,
<span id='KEY_CODE-property-close braket'>        /** @property */
</span>        &quot;close braket&quot;  : 221,
<span id='KEY_CODE-property-single quote'>        /** @property */
</span>        &quot;single quote&quot;  : 222,
<span id='KEY_CODE-property-space'>        /** @property */
</span>        &quot;space&quot;         : 32
    };
    
    
})();

</pre>
</body>
</html>
